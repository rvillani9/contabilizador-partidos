# ETAPA 1: Construir el Frontend (Expo Web)
FROM node:20 AS frontend-build
WORKDIR /app/frontend

# Copiamos archivos de Node y descargamos dependencias
COPY mobile-app/package*.json ./
RUN npm install

# Copiamos el resto y exportamos la web
COPY mobile-app/ ./
RUN npx expo export --platform web

# ETAPA 2: Construir el Backend (Java)
FROM maven:3.9.6-eclipse-temurin-21 AS backend-build
WORKDIR /app/backend

# Copiamos el pom y el código
COPY backend/pom.xml .
COPY backend/src ./src

# TRUCO: Copiamos la web de la etapa 1 a la carpeta estática de Java
COPY --from=frontend-build /app/frontend/dist ./src/main/resources/static

# Compilamos el JAR con la web adentro
RUN mvn clean package -DskipTests

# ETAPA 3: Ejecución final
FROM eclipse-temurin:21-jre-jammy
WORKDIR /app
COPY --from=backend-build /app/backend/target/app.jar app.jar

# Límites de memoria para que Render no lo mate
EXPOSE 8080
ENTRYPOINT ["java", "-Xmx400m", "-Xms400m", "-jar", "app.jar"]